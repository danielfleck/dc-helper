FROM php:8.1.9-apache

RUN set -eux \
	&& apt-get update --no-allow-insecure-repositories \
	&& apt-get --assume-yes --auto-remove upgrade \
	&& apt-get --assume-yes autoremove \
	&& apt-get clean \
	&& rm -r /var/lib/apt/lists/*

COPY php.ini-development /usr/local/etc/php/php.ini
COPY conf.d/ /usr/local/etc/php/conf.d/
COPY certs/server.pem /etc/ssl/certs/server.pem
COPY certs/server.crt /etc/ssl/certs/server.crt
COPY certs/server.key /etc/ssl/private/server.key

COPY vhosts/000-default.conf /etc/apache2/sites-available/000-default.conf
COPY vhosts/default-ssl.conf /etc/apache2/sites-available/default-ssl.conf

RUN a2enmod rewrite \
    && a2ensite default-ssl \
    && sed -i s%ssl-cert-snakeoil.pem%server.crt%g /etc/apache2/sites-enabled/default-ssl.conf \
    && sed -i s%ssl-cert-snakeoil.key%server.key%g /etc/apache2/sites-enabled/default-ssl.conf

# resolve o problema que impedia o usuário www-data de gravar no diretório /var/www/html
RUN usermod --non-unique --uid 1000 www-data \
  && groupmod --non-unique --gid 1000 www-data \
  && chown -R www-data:www-data /var/www
